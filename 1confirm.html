<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Confirm Pickup</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:'Poppins',sans-serif;
}

body{
    background:#f5f6f7;
}

/* Top App Bar */
.app-bar{
    background:#174a56;
    color:white;
    padding:18px 16px;
    font-size:18px;
    font-weight:600;
    display:flex;
    align-items:center;
}

.app-bar span{
    font-size:22px;
    margin-right:15px;
    cursor:pointer;
}

/* Main Container */
.container{
    padding:16px;
}

/* Card */
.card{
    background:white;
    border-radius:12px;
    padding:16px;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
    margin-bottom:16px;
}

/* Section Titles */
.section-title{
    font-weight:600;
    margin-bottom:10px;
    color:#333;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.preview-btn{
    background:#174a56;
    color:white;
    border:none;
    padding:6px 14px;
    border-radius:8px;
    font-size:12px;
    cursor:pointer;
}

/* Divider */
.divider{
    height:1px;
    background:#eee;
    margin:10px 0;
}

/* Item Chip */
.chip{
    display:inline-block;
    padding:6px 12px;
    background:#f0f0f0;
    border-radius:20px;
    font-size:13px;
    margin-top:6px;
}

/* Address Section */
.address-title{
    font-weight:600;
    color:#174a56;
    margin-bottom:5px;
}

.sub-text{
    font-size:13px;
    color:#777;
    margin-bottom:10px;
}

.address-row{
    display:flex;
    align-items:flex-start;
    font-size:14px;
    color:#333;
}

.address-row span{
    margin-right:8px;
}

/* Confirm Card */
.confirm-card{
    text-align:center;
}

.confirm-card p{
    font-weight:500;
    margin-bottom:14px;
}

.confirm-btn{
    width:100%;
    background:#174a56;
    color:white;
    border:none;
    padding:14px;
    border-radius:10px;
    font-size:16px;
    font-weight:500;
    cursor:pointer;
}

.confirm-btn:disabled{
    opacity:0.6;
    cursor:not-allowed;
}

/* Bottom Section */
.bottom{
    text-align:center;
    margin-top:25px;
    color:#555;
    font-size:14px;
}

/* Toast */
.toast{
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    background:#333;
    color:white;
    padding:10px 18px;
    border-radius:8px;
    display:none;
    z-index:999;
}










    
    #loading {
      
       margin-left: 20px;
     margin-right: 20px;
     margin-bottom: 400px;
     margin-top: 300px;
     padding: 20px;
      font-size: 20px;
      display: none;
    }

    #error-box {
    width: 300px;
    padding: 20px;
    background-color: white;
      justify-content: center;  /* center horizontally */
    align-items: center; 
    border: 1px solid black;
    border-radius: 8px;
    margin-top: 250px;
    margin-bottom: 450PX;
    text-align: center;
    /* margin: 20px auto; */
    font-family: Arial, sans-serif;
    }

    #error-box button {
      background: #34495e;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }







    
        .login-box {
               /* margin-left: 10px; */
    /* max-width: 420px; */
   
    padding: 10px;
    background: #34495e;
    color: white;
        }

        .login-box h1 {
            font-size: 48px;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .login-box h2 {
            font-size: 28px;
            margin-bottom: 15px;
            font-weight: 400;
        }

        .login-box h3 {
            font-size: 16px;
            font-weight: normal;
            margin-bottom: 35px;
            color: #ccc;
        }

        .login-btn {
              padding: 14px 42px;
    font-size: 16px;
    background: #fff;
    color: #000;
    border: none;
    border-radius: 30px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    width: 100%;
        }

        .login-btn:hover {
            background: #e0e0e0;
        }


   .screen {
               width: 100%;
    height: 100vh;
    display: flex;
    background: #34495e;
    align-items: start;
    padding-top: 100px;
        }

        #loading,
#login-box,
#error-box {
    display: none;
}
</style>
</head>

<body>

<div class="app-bar">
    <span onclick="goBack()">‚Üê</span>
    Confirm Pickup
</div>

<div class="container" id="main-content">

    <div class="card">
        <div class="section-title">
            Pickup Summary
            <button class="preview-btn">Preview</button>
        </div>

        <div class="divider"></div>

        <strong>Items</strong><br>
        <div id="itemsContainer"></div>

        <div class="divider"></div>

        <strong>Pickup Details</strong>
        <div style="margin-top:8px;font-size:14px;color:#444;">
            üìÖ <span id="pickupDate"></span><br>
            ‚è∞ <span id="pickupTime"></span>
        </div>
    </div>

    <div>
        <div class="address-title">Pickup Address</div>
        <div class="sub-text">This is the address selected for the pickup.</div>

        <div class="address-row">
            <span>üè†</span>
            <div id="pickupAddress"></div>
        </div>
    </div>

    <div class="card confirm-card">
        <p>Ready to confirm your pickup?</p>
        <button class="confirm-btn" id="confirmBtn">‚úî Confirm Pickup</button>
    </div>

    <div class="bottom">
        Everything looks great!
    </div>

</div>


   <div id="loading">
    <div class="spinner"></div>
    Loading...
  </div>
<div class="screen" id="login-box">
        <div class="login-box">
            <h1>Cyklze</h1>
            <h2>Login</h2>
            <h3>Login required to continue placing order</h3>
            <button class="login-btn" onclick="goToLogin()">Login</button>
        </div>
    </div>

  <div id="error-box">
    <h3>Something went wrong!</h3>
    <p>Please try again.</p>
    <button onclick="checkTokenAndNavigate()">Retry</button>
  </div>
<div id="toast" class="toast"></div>

<script>

/* ------------------ GET DATA ------------------ */
const date = localStorage.getItem('selectedDate');
const time = date // ‚úÖ FIXED
const items = JSON.parse(localStorage.getItem('items')) || [];
const address = localStorage.getItem('address');
const storedImage = localStorage.getItem("selectedImage");
//   selectedImage
console.log(items);
console.log(localStorage.getItem('items_dummy'));
/* ------------------ DISPLAY DATA ------------------ */
document.getElementById("pickupDate").textContent = date || "Not selected";
document.getElementById("pickupTime").textContent = time || "Not selected";
document.getElementById("pickupAddress").textContent = address || "No address selected";
const imageToSend = storedImage && storedImage.trim() !== "" ? storedImage : "no";
/* ------------------ DISPLAY ITEMS ------------------ */
const itemsContainer = document.getElementById("itemsContainer");

if (Array.isArray(items) && items.length > 0) {
    items.forEach(item => {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = item; // Shows "plastic: 10"
        itemsContainer.appendChild(chip);
    });
} else {
    itemsContainer.textContent = "No items selected";
}

/* ------------------ HELPERS ------------------ */

function showToast(message){
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.style.display = "block";
    setTimeout(()=> toast.style.display="none", 3000);
}

function goBack(){
    window.history.back();
}

/* ------------------ TOKEN CHECK ------------------ */

async function isTokenExpired() {
    const accessToken = localStorage.getItem('accessToken');
      document.getElementById("loading").style.display = "block";
      document.getElementById("error-box").style.display = "none";
      document.getElementById("main-content").style.display = "none";
      document.getElementById("login-box").style.display = "none";

    try {
        const response = await fetch(
            'https://0gb8de1kda.execute-api.us-east-1.amazonaws.com/2order/2order/checkTokenExpiration',
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': accessToken
                },
                body: JSON.stringify({ accessToken })
            }
        );

        if (!response.ok) return true;

        const data = await response.json();
        return false;

    } catch (error) {
         document.getElementById("loading").style.display = "none";
      document.getElementById("error-box").style.display = "block";
      document.getElementById("main-content").style.display = "none";
      document.getElementById("login-box").style.display = "none";
        console.error("Token check error:", error);
        return true;
    }
}

async function checkTokenAndNavigate(){
    const accessToken = localStorage.getItem('accessToken');

    if(!accessToken){
        document.getElementById("loading").style.display = "none";
      document.getElementById("error-box").style.display = "none";
      document.getElementById("main-content").style.display = "none";
      document.getElementById("login-box").style.display = "block";
        return;
    }

    const expired = await isTokenExpired();
    if(expired){
        document.getElementById("loading").style.display = "none";
      document.getElementById("error-box").style.display = "block";
      document.getElementById("main-content").style.display = "none";
      document.getElementById("login-box").style.display = "none";
    }else{
 document.getElementById("loading").style.display = "none";
      document.getElementById("error-box").style.display = "none";
      document.getElementById("main-content").style.display = "block";
      document.getElementById("login-box").style.display = "none";
    }
}

window.onload = checkTokenAndNavigate;

/* ------------------ CONFIRM PICKUP ------------------ */

document.getElementById("confirmBtn").addEventListener("click", handleConfirm);
window.onload = function () {
  myFunction();
};
    function goToLogin() {
    // Redirect to your login page
     localStorage.setItem("previousPage", window.location.href);
  window.location.replace("login.html");

}

function myFunction() {
  const items = localStorage.getItem("items");
  const image = localStorage.getItem("selectedImage");
    const date = localStorage.getItem("selectedDate");
  // Check for null OR empty string
  if (!items || items === "[]" || !image || image === "[]" ||!date || date === "[]") {
    window.location.replace("index.html");
  }
}
async function handleConfirm(){

    if (!address || !date || !time) {
        showToast("Missing pickup details");
        return;
    }

    // if (!address.toLowerCase().includes("hyderabad")) {
    //     alert("The address must contain 'Hyderabad'.");
    //     return;
    // }

    const button = document.getElementById("confirmBtn");
    button.disabled = true;
    button.textContent = "Processing...";

    try {
        const accessToken = localStorage.getItem('accessToken');

        if (!accessToken) {
             document.getElementById("loading").style.display = "none";
      document.getElementById("error-box").style.display = "none";
      document.getElementById("main-content").style.display = "none";
      document.getElementById("login-box").style.display = "block";
            return;
        }

        // ‚úÖ Convert ['plastic: 10'] ‚Üí structured format
        const structuredItems = items.map(item => {
            const [name, qty] = item.split(":");
            return {
                name: name.trim(),
                quantity: Number(qty.trim())
            };
        });

        const response = await fetch(
            'https://0gb8de1kda.execute-api.us-east-1.amazonaws.com/2order/2order',
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': accessToken
                },
              body: JSON.stringify({
    address,
    date,
    time,
    items: structuredItems,
    type: "pickup",
    image: imageToSend
})
            }
        );

        const data = await response.json();

        if(response.ok){
         if (data.message && data.message.toLowerCase() === "pending") {
            alert("Your recent order is still pending. You cannot schedule another pickup.");
            return;
        }else{
  window.location.href = "Confirmed.html";
        }
          
        } else {
              document.getElementById("loading").style.display = "none";
      document.getElementById("error-box").style.display = "block";
      document.getElementById("main-content").style.display = "none";
      document.getElementById("login-box").style.display = "none";
        }

    } catch(error){
        console.error(error);
         document.getElementById("loading").style.display = "none";
      document.getElementById("error-box").style.display = "block";
      document.getElementById("main-content").style.display = "none";
      document.getElementById("login-box").style.display = "none";
    } finally {
        button.disabled = false;
        button.textContent = "‚úî Confirm Pickup";
    }
}

</script>

</body>
</html>
