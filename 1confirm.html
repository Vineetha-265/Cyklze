<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Confirm Pickup</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:'Poppins',sans-serif;
}

body{
    background:#f5f6f7;
}

/* Top App Bar */
.app-bar{
    background:#174a56;
    color:white;
    padding:18px 16px;
    font-size:18px;
    font-weight:600;
    display:flex;
    align-items:center;
}

.app-bar span{
    font-size:22px;
    margin-right:15px;
    cursor:pointer;
}

/* Main Container */
.container{
    padding:16px;
}

/* Card */
.card{
    background:white;
    border-radius:12px;
    padding:16px;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
    margin-bottom:16px;
}

/* Section Titles */
.section-title{
    font-weight:600;
    margin-bottom:10px;
    color:#333;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.preview-btn{
    background:#174a56;
    color:white;
    border:none;
    padding:6px 14px;
    border-radius:8px;
    font-size:12px;
    cursor:pointer;
}

/* Divider */
.divider{
    height:1px;
    background:#eee;
    margin:10px 0;
}

/* Item Chip */
.chip{
    display:inline-block;
    padding:6px 12px;
    background:#f0f0f0;
    border-radius:20px;
    font-size:13px;
    margin-top:6px;
}

/* Address Section */
.address-title{
    font-weight:600;
    color:#174a56;
    margin-bottom:5px;
}

.sub-text{
    font-size:13px;
    color:#777;
    margin-bottom:10px;
}

.address-row{
    display:flex;
    align-items:flex-start;
    font-size:14px;
    color:#333;
}

.address-row span{
    margin-right:8px;
}

/* Confirm Card */
.confirm-card{
    text-align:center;
}

.confirm-card p{
    font-weight:500;
    margin-bottom:14px;
}

.confirm-btn{
    width:100%;
    background:#174a56;
    color:white;
    border:none;
    padding:14px;
    border-radius:10px;
    font-size:16px;
    font-weight:500;
    cursor:pointer;
}

.confirm-btn:disabled{
    opacity:0.6;
    cursor:not-allowed;
}

/* Bottom Section */
.bottom{
    text-align:center;
    margin-top:25px;
    color:#555;
    font-size:14px;
}

/* Toast */
.toast{
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    background:#333;
    color:white;
    padding:10px 18px;
    border-radius:8px;
    display:none;
    z-index:999;
}
</style>
</head>

<body>

<div class="app-bar">
    <span onclick="goBack()">‚Üê</span>
    Confirm Pickup
</div>

<div class="container">

    <div class="card">
        <div class="section-title">
            Pickup Summary
            <button class="preview-btn">Preview</button>
        </div>

        <div class="divider"></div>

        <strong>Items</strong><br>
        <div id="itemsContainer"></div>

        <div class="divider"></div>

        <strong>Pickup Details</strong>
        <div style="margin-top:8px;font-size:14px;color:#444;">
            üìÖ <span id="pickupDate"></span><br>
            ‚è∞ <span id="pickupTime"></span>
        </div>
    </div>

    <div>
        <div class="address-title">Pickup Address</div>
        <div class="sub-text">This is the address selected for the pickup.</div>

        <div class="address-row">
            <span>üè†</span>
            <div id="pickupAddress"></div>
        </div>
    </div>

    <div class="card confirm-card">
        <p>Ready to confirm your pickup?</p>
        <button class="confirm-btn" id="confirmBtn">‚úî Confirm Pickup</button>
    </div>

    <div class="bottom">
        Everything looks great!
    </div>

</div>

<div id="toast" class="toast"></div>

<script>

/* ------------------ GET DATA ------------------ */
const date = localStorage.getItem('selectedDate');
const time = date // ‚úÖ FIXED
const items = JSON.parse(localStorage.getItem('items')) || [];
const address = localStorage.getItem('address');
const storedImage = localStorage.getItem("selectedImage");
//   selectedImage
console.log(items);
console.log(localStorage.getItem('items_dummy'));
/* ------------------ DISPLAY DATA ------------------ */
document.getElementById("pickupDate").textContent = date || "Not selected";
document.getElementById("pickupTime").textContent = time || "Not selected";
document.getElementById("pickupAddress").textContent = address || "No address selected";
const imageToSend = storedImage && storedImage.trim() !== "" ? storedImage : "no";
/* ------------------ DISPLAY ITEMS ------------------ */
const itemsContainer = document.getElementById("itemsContainer");

if (Array.isArray(items) && items.length > 0) {
    items.forEach(item => {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = item; // Shows "plastic: 10"
        itemsContainer.appendChild(chip);
    });
} else {
    itemsContainer.textContent = "No items selected";
}

/* ------------------ HELPERS ------------------ */

function showToast(message){
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.style.display = "block";
    setTimeout(()=> toast.style.display="none", 3000);
}

function goBack(){
    window.history.back();
}

/* ------------------ TOKEN CHECK ------------------ */

async function isTokenExpired() {
    const accessToken = localStorage.getItem('accessToken');

    try {
        const response = await fetch(
            'https://0gb8de1kda.execute-api.us-east-1.amazonaws.com/2order/2order/checkTokenExpiration',
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': accessToken
                },
                body: JSON.stringify({ accessToken })
            }
        );

        if (!response.ok) return true;

        const data = await response.json();
        return data.message === "Token has expired";

    } catch (error) {
        console.error("Token check error:", error);
        return true;
    }
}

async function checkTokenAndNavigate(){
    const accessToken = localStorage.getItem('accessToken');

    if(!accessToken){
        alert("Please log in");
        window.location.href = "login.html";
        return;
    }

    const expired = await isTokenExpired();
    if(expired){
        alert("Session expired. Please log in again.");
        window.location.href = "login.html";
    }
}

window.onload = checkTokenAndNavigate;

/* ------------------ CONFIRM PICKUP ------------------ */

document.getElementById("confirmBtn").addEventListener("click", handleConfirm);

async function handleConfirm(){

    if (!address || !date || !time) {
        showToast("Missing pickup details");
        return;
    }

    if (!address.toLowerCase().includes("hyderabad")) {
        alert("The address must contain 'Hyderabad'.");
        return;
    }

    const button = document.getElementById("confirmBtn");
    button.disabled = true;
    button.textContent = "Processing...";

    try {
        const accessToken = localStorage.getItem('accessToken');

        if (!accessToken) {
            showToast("Authentication failed. Please login.");
            window.location.href = "login.html";
            return;
        }

        // ‚úÖ Convert ['plastic: 10'] ‚Üí structured format
        const structuredItems = items.map(item => {
            const [name, qty] = item.split(":");
            return {
                name: name.trim(),
                quantity: Number(qty.trim())
            };
        });

        const response = await fetch(
            'https://0gb8de1kda.execute-api.us-east-1.amazonaws.com/2order/2order',
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': accessToken
                },
              body: JSON.stringify({
    address,
    date,
    time,
    items: structuredItems,
    type: "pickup",
    image: imageToSend
})
            }
        );

        const data = await response.json();

        if(response.ok){
         if (data.message && data.message.toLowerCase() === "pending") {
            alert("Your recent order is still pending. You cannot schedule another pickup.");
            return;
        }else{
  window.location.href = "Confirmed.html";
        }
          
        } else {
            showToast(data.message || "Something went wrong");
        }

    } catch(error){
        console.error(error);
        showToast("Failed to connect. Try again later.");
    } finally {
        button.disabled = false;
        button.textContent = "‚úî Confirm Pickup";
    }
}

</script>

</body>
</html>
