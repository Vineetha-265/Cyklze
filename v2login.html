<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Login</title>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: "Poppins", sans-serif;
        background: #f0f4f9;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }

    /* Splash Screen */
    #splashScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
        font-size: 28px;
        font-weight: 600;
    }

    /* Login Card */
    .login-card {
        width: 90%;
        max-width: 380px;
        background: white;
        padding: 32px;
        border-radius: 18px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        display: none;
    }

    .title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 10px;
        text-align: center;
        color: #1d4d61;
    }

    .subtitle {
        font-size: 14px;
        text-align: center;
        margin-bottom: 20px;
        color: #515151;
    }

    input {
        width: 100%;
        padding: 14px;
        border-radius: 10px;
        border: 1px solid #c7d5e0;
        font-size: 16px;
        margin-bottom: 15px;
    }

    button {
        width: 100%;
        padding: 14px;
        background: #1d4d61;
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
    }

    button:disabled {
        background: #9bb8c7;
        cursor: not-allowed;
    }

    #otpSection {
        display: none;
    }

    /* Toast */
    #toast {
        visibility: hidden;
        min-width: 260px;
        background: #1d4d61;
        color: white;
        text-align: center;
        padding: 14px;
        border-radius: 8px;
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        font-size: 16px;
    }

    #toast.show {
        visibility: visible;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }

    @keyframes fadein {
        from {bottom: 10px; opacity: 0;}
        to {bottom: 30px; opacity: 1;}
    }

    @keyframes fadeout {
        from {bottom: 30px; opacity: 1;}
        to {bottom: 10px; opacity: 0;}
    }

    /* Loading Spinner */
    #loadingSpinner {
        display: none;
        margin: 10px auto;
        border: 5px solid #eee;
        border-top: 5px solid #1d4d61;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        100% { transform: rotate(360deg); }
    }

    .timer {
        text-align: center;
        margin-top: 8px;
        font-size: 14px;
        color: #1d4d61;
        display: block;
    }
</style>
</head>

<body>

<!-- Splash Screen -->
<div id="splashScreen">
    Loading...
</div>

<!-- Login UI -->
<div id="verifyContent" class="login-card">

    <div class="title">Welcome</div>
    <div class="subtitle">Login with your phone number</div>

    <input type="text" id="phoneNumber" placeholder="Enter 10-digit phone number" maxlength="10">

    <button id="sendOtpButton">Send OTP</button>

    <div id="loadingSpinner"></div>

    <div id="otpSection">
        <p style="text-align:center; font-size:14px;">
            OTP sent to <b id="phoneNumberText"></b>
        </p>

        <input type="text" id="otp" placeholder="Enter 6-digit OTP" maxlength="6">

        <span id="timerText" class="timer">Enter OTP within 120s</span>

        <button id="verifyOtpButton">Verify OTP</button>
    </div>
</div>

<!-- Toast -->
<div id="toast"></div>


<!-- YOUR FULL SCRIPT INSERTED BELOW -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const splashScreen = document.getElementById('splashScreen');
    const verifyContent = document.getElementById('verifyContent');
    const phoneNumberInput = document.getElementById('phoneNumber');
    const sendOtpButton = document.getElementById('sendOtpButton');
    const otpSection = document.getElementById('otpSection');
    const otpInput = document.getElementById('otp');
    const verifyOtpButton = document.getElementById('verifyOtpButton');
    const timerText = document.getElementById('timerText');
    const phoneNumberText = document.getElementById('phoneNumberText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    let cooldown = 120;
    let otpCooldownTimer;

    // Splash screen
    setTimeout(() => {
        splashScreen.style.display = 'none';
        verifyContent.style.display = 'block';
    }, 3000);

    function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "show";
        setTimeout(() => {
            toast.className = toast.className.replace("show", "");
        }, 3000);
    }

    const startOtpCooldown = () => {
        sendOtpButton.disabled = true;
        phoneNumberInput.disabled = true;
        phoneNumberText.textContent = phoneNumberInput.value;

        otpCooldownTimer = setInterval(() => {
            cooldown--;
            timerText.textContent = `Enter OTP within ${cooldown}s`;

            if (cooldown <= 0) {
                clearInterval(otpCooldownTimer);
                sendOtpButton.disabled = false;
                phoneNumberInput.disabled = false;
            }
        }, 1000);
    };

    sendOtpButton.addEventListener('click', async () => {
        const phoneNumber = phoneNumberInput.value;

        if (!/^[0-9]{10}$/.test(phoneNumber)) {
            alert("Please enter a valid 10-digit phone number.");
            return;
        }

        loadingSpinner.style.display = 'block';

        try {
            const response = await fetch('https://0gb8de1kda.execute-api.us-east-1.amazonaws.com/2order/2order/verify-otp', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer YOUR_ACCESS_TOKEN',
                },
                body: JSON.stringify({ phoneNumber }),
            });

            const responseBody = await response.json();

            if (response.ok) {
                showToast("OTP sent successfully.");
                otpSection.style.display = 'block';
                startOtpCooldown();
            } else {
                alert(`Failed to send OTP: ${responseBody.error || 'Unknown error'}`);
            }
        } catch (error) {
            alert("Error sending OTP.");
        } finally {
            loadingSpinner.style.display = 'none';
        }
    });

    async function checkTokenAndNavigate() {
        const accessToken = getCookie('accessToken');

        if (accessToken) {
            const isExpired = await isTokenExpired();
            if (isExpired) {
                alert('Please log in');
            } else {
                window.location.href = 'index.html';
            }
        } else {
            alert('Please log in');
        }
    }

    const isTokenExpired = async () => {
        const accessToken = getCookie('accessToken');
        try {
            const response = await fetch('https://0gb8de1kda.execute-api.us-east-1.amazonaws.com/2order/2order/checkTokenExpiration', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `${accessToken}`,
                },
                body: JSON.stringify({ accessToken }),
            });

            const responseData = await response.json();
            return responseData.message === 'Token has expired';
        } catch (error) {
            alert('Failed to check token expiration.');
            return true;
        }
    };

    verifyOtpButton.addEventListener('click', async () => {
        const otp = otpInput.value;

        if (otp.length !== 6 || !/^[0-9]{6}$/.test(otp)) {
            alert("OTP must be exactly 6 digits.");
            return;
        }

        try {
            const response = await fetch('https://0gb8de1kda.execute-api.us-east-1.amazonaws.com/2order/2order/verify-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer YOUR_ACCESS_TOKEN',
                },
                body: JSON.stringify({ phoneNumber: phoneNumberInput.value, otp }),
            });

            if (response.ok) {
                const data = await response.json();
                alert("OTP verified successfully.");

                setCookie('accessToken', data.accessToken, 30);
                setCookie('refreshToken', data.refreshToken, 30);

                window.location.href = "index.html";
            } else {
                alert("Invalid OTP.");
            }
        } catch (error) {
            alert("Error verifying OTP.");
        }
    });

    function setCookie(name, value, days) {
        const expires = new Date();
        expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = `${name}=${value}; expires=${expires.toUTCString()}; path=/`;
    }

    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    window.onload = function() {
        checkTokenAndNavigate();
    };

});
</script>

</body>
</html>
